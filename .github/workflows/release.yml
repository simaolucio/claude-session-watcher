name: Build and Release

on:
  push:
    tags:
      - "v*.*.*"

permissions:
  contents: write

jobs:
  build:
    runs-on: macos-15
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Build with xcodebuild
        run: |
          xcodebuild \
            -project CodeQuota.xcodeproj \
            -scheme CodeQuota \
            -configuration Release \
            -derivedDataPath build \
            CODE_SIGN_IDENTITY="-" \
            CODE_SIGNING_REQUIRED=YES \
            CODE_SIGNING_ALLOWED=YES

      - name: Ad-hoc sign the app bundle
        run: codesign --force --deep --sign - build/Build/Products/Release/CodeQuota.app

      - name: Install create-dmg
        run: brew install create-dmg

      - name: Create DMG
        run: |
          create-dmg \
            --volname "CodeQuota" \
            --volicon "CodeQuota/Assets.xcassets/AppIcon.appiconset/AppIcon-512@2x.png" \
            --window-pos 200 120 \
            --window-size 660 400 \
            --icon-size 160 \
            --icon "CodeQuota.app" 180 170 \
            --hide-extension "CodeQuota.app" \
            --app-drop-link 480 170 \
            --no-internet-enable \
            "CodeQuota-${{ github.ref_name }}.dmg" \
            "build/Build/Products/Release/CodeQuota.app"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: CodeQuota-*.dmg
          generate_release_notes: true

      - name: Trigger website rebuild
        run: curl -X POST "${{ secrets.VERCEL_DEPLOY_HOOK }}"
